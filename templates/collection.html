{% extends "layout.html" %}
{% block title %}{{ collection.name }}{% endblock %}
{% block header_content %}
{% endblock %}
{% block body_content %}
<div class="collection-container" data-collection-id="{{ collection.id }}">
    <div class="release-counts-container pull-right">
        <span class="release-count">Releases: <span class="badge" data-toggle="tooltip" data-placement="bottom"
                                                    title="Total Releases in Collection">{{ counts.releaseCount }}</span></span>
        <span class="track-count">Tracks: <span class="badge" data-toggle="tooltip" data-placement="bottom"
                                                title="Total Tracks of Collection">{{ counts.trackCount }}</span></span>
        <span class="length-total">Time: <span class="badge" data-toggle="tooltip" data-placement="bottom"
                                               title="Total Playtime of Collection">{{ counts.trackDuration|format_timedelta("{days}:{hours2}:{minutes2}:{seconds2}") }}</span></span>
    </div>
    <div class="btn-toolbar edit-toolbar" role="toolbar">
        <div class="btn-group">
            <button id="playAll" type="button" class="btn btn-default" aria-haspopup="true" aria-expanded="false">
                <i class="fa fa-play"></i> Play All
            </button>
        </div>
        {% if current_user.is_editor() %}
        <div class="btn-group">
            <a href="/admin/collection/edit/?id={{ collection.id }}&url=/collection/{{ collection.roadieId }}"
               type="button" class="btn btn-warning"><i class="fa fa-edit"></i> Edit</a>
            <a id="delete-collection" class="btn btn-warning"><i class="fa fa-trash-o"></i> Delete</a>
            {% if collection.listInCSVFormat and collection.listInCSV %}
            <a id="updateCollection" class="btn btn-warning"><i class="fa fa-bolt"></i> Update</a>
            {% endif %}
        </div>
        {% endif %}
    </div>
    <div class="row title bordered">
        <img class="collection-thumb thumb pull-left" src="/images/collection/thumbnail/{{ collection.roadieId }}"
             alt="{{ collection.title }}"/>
        {% if collection.urls %}
        <a class="external-link pull-left" target="_blank" href="{{ collection.urls[0] }}"><span
                class="fa fa-external-link fa-2x"></span></a>
        {% endif %}
        <h2><span class="label label-default">{{ collection.name }}</span></h2>
    </div>
    {%for collectionRelease in collection.collectionReleases|sort(attribute='listNumber') %}
    {% if collectionRelease.release and collectionRelease.release.artist %}
    <div class="collection-release pull-left" data-release-id="{{ collectionRelease.release.roadieId }}"
         data-listnumber="{{ collectionRelease.listNumber }}">
        <a href="/release/{{ collectionRelease.release.roadieId }}">
            <div class="thumbnail-container pull-left">
                <img class="release-thumb" src="/images/release/thumbnail/{{ collectionRelease.release.roadieId }}"
                     alt="{{ collectionRelease.release.title }}"/>
            </div>
            <h4><span class="label label-primary pull-left">{{ '%03d' % collectionRelease.listNumber  }}</span></h4>

            <div class="artist-info">
                <img class="thumb pull-left"
                     src="/images/artist/thumbnail/{{ collectionRelease.release.artist.roadieId }}"
                     alt="{{ collectionRelease.release.artist.name }}"/>
                <h5><a title="View Artist" href="/artist/{{ collectionRelease.release.artist.roadieId }}"><span
                        class="label label-info">{{ collectionRelease.release.artist.name }}</span></a></h5>
            </div>
            <div class="release-rating-container">
                <input type="hidden" class="rating" data-readonly value="{{ collectionRelease.release.rating }}"/>
            </div>
            <h3 class="album-title"><span class="label label-default">{{ collectionRelease.release.title }}</span></h3>
        </a>
    </div>
    {% endif %}
    {% endfor %}
    <div class="clearfix"></div>
    {% if notFoundEntryInfos %}
    <div class="bordered">
        {% for notFoundEntryInfo in notFoundEntryInfos|sort(attribute='artist') %}
        <div class="row not-found">
            <div class="col-md-5">
                [{{ notFoundEntryInfo['artist'] }}]
            </div>
            <div class="col-md-5">
                [{{ notFoundEntryInfo['release'] }}]
            </div>
            <div class="col-md-2">
                [{{ notFoundEntryInfo['position'] }}]
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}
    <div class="row missing bordered">
    </div>
</div>
{% endblock %}
{% block script_content %}
<script type="text/javascript">
    var collectionId = '{{ collection.roadieId }}';
    var collectionCountShouldBe = {{ collection.listInCSV|count_new_lines + 1 }};
    var missing = [];

    var showCollectionSane = function(isSane) {
        var $c = $("div.release-counts-container");
        $c.find(".release-sane-indicator").remove();
        if(isSane) {
            $c.append("<span class='release-sane-indicator release-sane label label-success' title='Collection Is Complete!'><i class='fa fa-check-square-o fa-2x'></i></span>");
        } else {
            $c.append("<span class='release-sane-indicator release-insane label label-danger' title='Collection Has Issues'><i class='fa fa-square-o fa-2x'></i></span>");
        }
    };

    $(function() {

        myNumbers = $.map($(".collection-release"), function(d) {
            return parseInt($(d).data("listnumber"));
        });
        for(var i = 1; i <= collectionCountShouldBe; i++) {
            if($.inArray(i, myNumbers) < 0) {
                missing.push(i);
           }
        };
        if(missing.length > 0) {
            var html = '<div><h4>Missing</h4></div>';
            $.each(missing, function(i,d) {
                html += '<h3 class="missing-number"><span class="label label-warning">' + d + '</span></h3>';
            });
            $(".missing").html(html);
            showCollectionSane(false);
        } else {
            $(".missing").hide();
            showCollectionSane(true);
        };
        $("#playAll").on("click", function(e) {
            roadieLibrary.playLoader("/collection/play/" + collectionId);
        });

        $("#updateCollection").on("click",function(e) {
            bootbox.confirm("Continue to Update List With Known Releases(s)?", function(result) {
                if(result) {
                    $(".loader").fadeIn("slow", function() {
                        $.ajax({
                            type: 'POST',
                            url: '/collection/update/' + collectionId,
                            contentType: "application/javascript",
                            success: function(data) {
                                if(data.message == "OK") {
                                    location.reload(true);
                                }
                            },
                            error:function(jq, st, error){
                                roadieLibrary.showErrorMessage(error);
                            }
                        });
                    });
                }
            });
        });
    });

</script>
{% endblock %}