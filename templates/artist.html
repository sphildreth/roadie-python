{% extends "layout.html" %}
{% block title %}{{ artist.Name }}{% endblock %}
{% block header_content %}
{% endblock %}
{% block body_content %}
    <div class="artist-detail-container" data-artist-id="{{ artist.id }}">
        <div class="release-counts-container pull-right">
            <span class="release-count">Releases: <span class="badge" data-toggle="tooltip" data-placement="bottom" title="Total Releases of Artist">{{ counts.releases }}</span></span>
            <span class="track-count">Tracks: <span class="badge" data-toggle="tooltip" data-placement="bottom" title="Total Tracks of Artist">{{ counts.tracks }}</span></span>
            <span class="length-total">Time: <span class="badge" data-toggle="tooltip" data-placement="bottom" title="Total Playtime of Artist">{{ counts.length|format_timedelta("{days}:{hours2}:{minutes2}:{seconds2}") }}</span></span>
        </div>
        <div class="btn-toolbar edit-toolbar" role="toolbar">
            <div class="btn-group">
              <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                <i class="fa fa-play"></i> Play <span class="caret"></span>
              </button>
              <ul class="dropdown-menu">
                <li><a id="playAll" href="#">Play All</a></li>
                  <li><a id="playAllShuffle" href="#">Play All (Shuffle)</a></li>
                <li><a id="playTopRated" href="#">Play Top Rated</a></li>
                <li><a id="playMostPopular" href="#">Play Most Popular</a></li>
              </ul>
            </div>
            {% if current_user.is_authenticated() and current_user.has_role("Admin") %}
              <div class="btn-group">
                <a href="/admin/artist/edit/?id={{ artist.id }}&url=/artist/{{ artist.id }}" type="button" class="btn btn-warning"><i class="fa fa-edit"></i> Edit</a>
                {% if artist.IsLocked == False %}
                <button id="delete-artist" class="btn btn-warning"><i class="fa fa-trash-o"></i> Delete</button>
                <button id="scan-artist" class="btn btn-warning"><i class="fa fa-folder-open-o"></i> Re-Scan</button>
                {% endif %}
             </div>
            {% endif %}
            {% if artist.IsLocked %}
                <span class="edit-locked label label-danger"><i class="fa fa-lock fa-2x" title="Artist Is Locked"></i></span>
            {% endif %}
        </div>
        <div class="row title bordered">
            <div class="thumbnail-container pull-left">
                <img class="thumb " src="/images/artist/thumbnail/{{ artist.id }}" alt="{{ artist.Name }}" />
            </div>
            <div class="rating-container">
                <input type="hidden" class="rating" data-readonly value="{{ artist.Rating }}" />
            </div>
            <h2><span class="label label-default">{{ artist.Name }}</span></h2>
            <div class="user-rating-container">
                <a href="#" class="dislike" title="Toggle Dislike Artist"><i class="fa {{ 'fa-thumbs-down' if userArtist.IsDisliked else 'fa-thumbs-o-down'}}"></i></a>
                <span class="reset-rating fa fa-square" title="Remove Rating"></span>
                <input type="hidden" class="user-rating rating" value="{{ userArtist.Rating }}" />
                <a href="#" class="favorite" title="Toggle Favorite Artist"><i class="fa {{'fa-heart' if userArtist.IsFavorite else 'fa-heart-o'}}"></i></a>
            </div>
        </div>
        <div class="row bordered">
            <div class="col-md-6">
                <h4><span class="label label-primary">Profile</span></h4>
                <p>{{ artist.Profile|safe }}</p>
            </div>
            <div class="col-md-6">
                {% for image in artist.Images %}
                    <div class="col-xs-4 col-sm-3 col-md-3">
                        <a href="javascript:void();"
                           data-title="{{ image.element.filename }}"
                           data-url="/images/artist/{{ artist.id}}/{{ image.element.grid_id }}/2048/2048"
                           target="_blank" class="thumbnail">
                            <img data-image-id="{{ image.element.grid_id }}" data-toggle="context" data-target="#context-menu-{{ image.element.grid_id }}" src="/images/artist/{{ artist.id}}/{{ image.element.grid_id }}/512/512" alt="Image" />
                        </a>
                    </div>
                    <div id="context-menu-{{ image.element.grid_id }}" data-image-id="{{ image.element.grid_id }}" class="context-menu">
                        <ul class="dropdown-menu" role="menu">
                        <li><a class="setArtistImage" tabindex="-1"><i class="fa fa-file-image-o"></i> Set as Artist Image</a></li>
                        </ul>
                    </div>
                {% endfor %}
            </div>
        </div>
        <div class="row details bordered">
            <div class="col-md-3">
                {% if artist.SortName %}
                <div>
                    <h4><span class="label label-primary">Sort Name</span></h4>
                    <span class="label label-default">{{ artist.SortName }}</span>
                </div>
                {% endif %}
                {% if artist.RealName %}
                <div>
                    <h4><span class="label label-primary">Real Name</span></h4>
                    <span class="label label-default">{{ artist.RealName }}</span>
                </div>
                {% endif %}
            </div>
            <div class="col-md-3">
                <div>
                    <h4><span class="label label-primary">Artist Type</span></h4>
                    <span class="label label-default">{{ artist.ArtistType.Name }}</span>
                </div>
                <div>
                    <h4><span class="label label-primary">MusicBrainz Id</span></h4>
                    {% if artist.MusicBrainzId %}
                    <a href="https://musicbrainz.org/artist/{{ artist.MusicBrainzId }}" target="_blank"><span class="label label-default">{{ artist.MusicBrainzId }}</span></a>
                    {% else %}
                    <span class="label label-default">None</span>
                    {% endif %}
                </div>
            </div>
            <div class="col-md-3">
                {% if artist.BirthDate %}
                <div>
                    <h4><span class="label label-primary">BirthDate</span></h4>
                    <span class="label label-default">{{ artist.BirthDate|format_age_from_date }}</span>
                </div>
                {% endif %}
                {% if artist.BeginDate %}
                <div>
                    <h4><span class="label label-primary">Begin Date</span></h4>
                    <span class="label label-default">{{ artist.BeginDate|format_age_from_date }}</span>
                </div>
                {% endif %}
                {% if artist.EndDate %}
                <div>
                    <h4><span class="label label-primary">End Date</span></h4>
                    <span class="label label-default">{{ artist.EndDate }}</span>
                </div>
                {% endif %}
            </div>
            <div class="col-md-3 associated-artists">
                {% if artist.AssociatedArtists %}
                <h4><span class="label label-primary">Associated Artists</span></h4>
                <ul>
                    {% for artist in artist.AssociatedArtists %}
                    <li>
                        <a href="/artist/{{ artist.id }}">
                        <div class="thumbnail-container pull-left">
                            <img class="thumb " src="/images/artist/thumbnail/{{ artist.id }}" alt="{{ artist.Name }}" />
                        </div>
                        <h3><span class="label label-default">{{ artist.Name }}</span></h3>
                        </a>
                    </li>
                    {% endfor %}
                </ul>
                {% endif %}
            </div>
        </div>
        {% if artist.AlternateNames or artist.Tags or artist.Urls %}
        <div class="row lists bordered">
            <div class="col-md-4">
                {% if artist.AlternateNames %}
                <h4><span class="label label-primary">Alternate Names</span></h4>
                <ul>
                    {% for alternateName in artist.AlternateNames %}
                    <li><span class="label label-default">{{ alternateName }}</span></li>
                    {% endfor %}
                </ul>
                {% endif %}
            </div>
            <div class="col-md-4">
                {% if artist.Tags %}
                <h4><span class="label label-primary">Tags</span></h4>
                <ul>
                    {% for tag in artist.Tags %}
                    <li><span class="label label-default">{{ tag }}</span></li>
                    {% endfor %}
                </ul>
                {% endif %}
            </div>
            <div class="col-md-4">
                {% if artist.Urls %}
                <h4><span class="label label-primary">Urls</span></h4>
                <ul>
                    {% for url in artist.Urls %}
                    <li><a href="{{ url.Url }}" target="_blank"><span class="label label-default">{{ url.Title }}</span></a></li>
                    {% endfor %}
                </ul>
                {% endif %}
            </div>
        </div>
        {% endif %}
        <div class="release-info-container">
            <div class="row bordered">
            {% for release in releases|sort(attribute='ReleaseDate') %}
                <div class="release pull-left" data-release-id="{{ release.id }}">
                    <div>
                        <img class="pull-left thumb" src="/images/release/thumbnail/{{ release.id}}" alt="{{ release.Title }}" />
                        <a href="/release/{{ release.id }}">
                        <h4><span class="label label-info releasedate">{{ release.ReleaseDate[:4] }}</span>
                            <span data-toggle="tooltip" data-placement="top" title="{{ release.Title }}" class="release-title label {{ 'label-danger' if (release.TrackCount == 0) or (release.TrackCount != release.Tracks|default('')|length) else 'label-default' }} releasetitle">{{ release.Title }}</span></h4>
                        </a>
                    </div>
                    {% for group in release.Tracks|sort(attribute='TrackNumber')|groupby('ReleaseMediaNumber') %}
                    {% if group.grouper > 0 %}
                    <h5 class="release-cd"><span class="label label-success pull-right">CD {{ group.grouper }}</span></h5>
                    {% endif %}
                    <ul class="tracks no-list-style">
                        {% for track in group.list %}
                        <li>
                            <span class="trackNumber label label-primary">{{ '%02d' % track.TrackNumber }} </span>
                            <span data-toggle="tooltip" data-placement="top" title="{{ track.Track.Title }}" class="title label label-default">{{ track.Track.Title }}</span>
                            <span class="length label label-info">{{ track.Track.Length|format_timedelta("{hours2}:{minutes2}:{seconds2}") }}</span>
                        </li>
                        {% endfor %}
                    </ul>
                    {% endfor %}
                </div>
            {% endfor %}
            </div>
        </div>
        <div class="meta pull-right">
            <p><span class="label label-info">Last Modified: {{ artist.LastUpdated }}</span></p>
        </div>
    </div>
{% endblock %}
{% block script_content %}
    <script type="text/javascript">
        var artistId = '{{ artist.id }}';

        var doArtistSanityChecks = function() {
            var $c = $("div.release-counts-container");
            $c.find(".release-sane-indicator").remove();
            var isSane = areNoInvalidReleasesFound();
            if(isSane) {
                $c.append("<span class='release-sane-indicator release-sane label label-success' title='Artist Seems Sane!'><i class='fa fa-check-square-o fa-2x'></i></span>");
            } else {
                $c.append("<span class='release-sane-indicator release-insane label label-danger' title='Artist Has Issues'><i class='fa fa-square-o fa-2x'></i></span>");
            }
        };

        var areNoInvalidReleasesFound = function() {
            return $("span.release-title.label-danger").length === 0;
        };

        $(function() {

            doArtistSanityChecks();

            $(".user-rating-container a.dislike").on("click", function(e) {
                var $i =  $(this).find("i:first");
                var toggle = !$i.hasClass("fa-thumbs-down");
                $.ajax({
                    type: 'POST',
                    url: '/user/artist/toggledislike/' + artistId + '/' + toggle,
                    contentType: "application/javascript",
                    success: function(data) {
                        if(data.message == "OK") {
                            roadieLibrary.showSuccessMessage("Successfully Toggled Dislike");
                            if(toggle) {
                                $i.removeClass("fa-thumbs-o-down").addClass("fa-thumbs-down");
                                $(".user-rating-container input.rating").rating('rate',0);
                                $(".rating-container input.rating").rating('rate', data.average);
                            } else {
                                $i.removeClass("fa-thumbs-down").addClass("fa-thumbs-o-down");
                            }
                        }
                    },
                    error:function(jq, st, error){
                        alert(error);
                    }
                });
            });
            $(".user-rating-container a.favorite").on("click", function(e) {
                var $i =  $(this).find("i:first");
                var toggle = !$i.hasClass("fa-heart");
                $.ajax({
                    type: 'POST',
                    url: '/user/artist/togglefavorite/' + artistId + '/' + toggle,
                    contentType: "application/javascript",
                    success: function(data) {
                        if(data.message == "OK") {
                            roadieLibrary.showSuccessMessage("Successfully Toggled Favorite");
                            if(toggle) {
                                $i.removeClass("fa-heart-o").addClass("fa-heart");
                            } else {
                                $i.removeClass("fa-heart").addClass("fa-heart-o");
                            }
                        }
                    },
                    error:function(jq, st, error){
                        alert(error);
                    }
                });
            });
            $(".user-rating-container input.rating").on("change", function(e) {
                $.ajax({
                    type: 'POST',
                    url: '/user/artist/setrating/' + artistId + '/' + $(this).rating('rate'),
                    contentType: "application/javascript",
                    success: function(data) {
                        if(data.message == "OK") {
                            $(".rating-container input.rating").rating('rate', data.average);
                            roadieLibrary.showSuccessMessage("Successfully Set Rating");
                        }
                    },
                    error:function(jq, st, error){
                        alert(error);
                    }
                });
            });

            $(".user-rating-container span.reset-rating").on("click", function(e) {
                var $rc = $(this).siblings("input.rating");
                $.ajax({
                    type: 'POST',
                    url: '/user/artist/setrating/' + artistId + '/0',
                    contentType: "application/javascript",
                    success: function(data) {
                        if(data.message == "OK") {
                            $rc.rating('rate', 0);
                            $(".rating-container input.rating").rating('rate', data.average);
                            roadieLibrary.showSuccessMessage("Successfully Removed Rating");
                        }
                    },
                    error:function(jq, st, error){
                        alert(error);
                    }
                });
            });

            $("#playAll").on("click", function(e) {
                roadieLibrary.playLoader("/artist/play/" + artistId + "/0");
            });
            $("#playAllShuffle").on("click", function(e) {
                roadieLibrary.playLoader("/artist/play/" + artistId + "/1");
            });
            $(".artist-detail-container a.thumbnail").on("click", function(e) {
                var $t = $(this);
                bootbox.dialog({
                    title: $t.data("title"),
                    size: 'large',
                    message: '<img src="' + $t.data("url") + '" style="max-width: 100%;" />'
                });
            });

            $("#scan-artist").on("click", function(e) {
                bootbox.confirm("Continue To Re-Scan Artist Release Folder(s)?", function(result) {
                    if(result) {
                        $(".loader").fadeIn("slow", function() {
                            $.ajax({
                                type: 'POST',
                                url: '/artist/rescan/' + artistId,
                                contentType: "application/javascript",
                                success: function(data) {
                                    if(data.message == "OK") {
                                        location.reload(true);
                                    }
                                },
                                error:function(jq, st, error){
                                    alert(error);
                                }
                            });
                        });
                    }
                });
            });

            $("#delete-artist").on("click", function(e) {
                bootbox.confirm("Continue To Delete Artist?", function(result) {
                    if(result) {
                        var $t = $(this);
                        $.ajax({
                            type: 'POST',
                            url: '/artist/delete/' + artistId,
                            contentType: "application/javascript",
                            success: function(data) {
                                if(data.message == "OK") {
                                    window.location.href = '/';
                                }
                            },
                            error:function(jq, st, error){
                                alert(error);
                            }
                        });
                    }
                });
            });
            $("a.setArtistImage").on("click", function(e) {
                var $t = $(this);
                var imageId = $t.parents(".context-menu").data("image-id");
                $.ajax({
                    type: 'POST',
                    url: '/artist/setimage/' + artistId + '/' + imageId,
                    contentType: "application/javascript",
                    success: function(data) {
                        $(".artist-detail-container .title img.thumb").attr("src", "/images/artist/thumbnail/" + artistId + "?" + new Date().getTime());
                    },
                    error:function(jq, st, error){
                        alert(error);
                    }
                });
            });
        });
    </script>
{% endblock %}