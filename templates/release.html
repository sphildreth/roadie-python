{% extends "layout.html" %}
{% block title %}{{ release.title }}{% endblock %}
{% block header_content %}
{% endblock %}
{% block body_content %}
<div class="release-detail-container releasetype_{{ release.releaseType|lower }} librarystatus_{{ release.libraryStatus|lower }}"
     data-release-id="{{ release.roadieId }}" data-release-db-id="{{ release.id }}">
    <div class="release-counts-container pull-right">
        <span data-media-count="{{ releaseMediaCount }}" class="media-count">Media: <span class="badge"
                                                                                          data-toggle="tooltip"
                                                                                          data-placement="bottom"
                                                                                          title="Total Media of Release">{{ '%02d' % releaseMediaCount }}</span></span>
        <span data-track-count="{{ trackCount }}" class="track-count">Tracks: <span class="badge" data-toggle="tooltip"
                                                                                    data-placement="bottom"
                                                                                    title="Total Tracks of Release">{{ '%03d' % trackCount }}</span></span>
        <span class="length-total">Time: <span class="badge" data-toggle="tooltip" data-placement="bottom"
                                               title="Total Playtime of Release">{{ releaseTrackTime or '--:--' }}</span></span>
        <span class="file-size">File Size: <span class="badge" data-toggle="tooltip" data-placement="bottom"
                                                 title="Total FileSize of Release">{{ releaseTrackFileSize }}</span></span>
    </div>
    <div class="breadcrumb-container">
        <ol class="breadcrumb">
           {% if releaseLabels|length > 0 %}
           <li>
               {% if releaseLabels|length == 1 %}
                {% for releaseLabel in releaseLabels %}
                   <a href="/label/{{ releaseLabel.label.roadieId }}">
                    <img class="label-thumb thumb" src="/images/label/thumbnail/{{ releaseLabel.label.roadieId }}"
                     alt="{{ releaseLabel.label.name }}"/>
                       <span class="label label-default release-label-name">{{ releaseLabel.label.name }}</span></a>
                {% endfor %}
               {% else %}
               <select id="labelPicker" class="form-control">
                   <option value="" disabled selected hidden>Labels</option>
                {% for releaseLabel in releaseLabels|sort(attribute='label.name') %}
                   <option value="{{ releaseLabel.label.roadieId }}">
                        <img class="label-thumb thumb" src="/images/label/thumbnail/{{ releaseLabel.label.roadieId }}"
                            alt="{{ releaseLabel.label.name }}"/>
                       <span class="label label-default release-label-name">{{ releaseLabel.label.name }}</span>
                    </option>
                {% endfor %}
               </select>
               {% endif %}
           </li>
           {% endif %}
           <li>
               <a href="/artist/{{ release.artist.roadieId }}">
                <img class="artist-thumb thumb" src="/images/artist/thumbnail/{{ release.artist.roadieId }}"
                 alt="{{ release.artist.name }}"/>
                   <span class="label label-default release-artist-name">{{ release.artist.name }}</span>
               </a>
           </li>
           <li class="active">
               <span class="label label-info">{{ release.title }}</span>
           </li>
        </ol>
    </div>
    <div class="btn-toolbar edit-toolbar" role="toolbar">
        <div class="btn-group">
            <a id="playAll" class="btn btn-default"><i class="fa fa-play"></i> Play</a>
            {% if current_user.is_editor() or current_user.has_role("Download") %}
            <a id="downloadRelease" class="btn btn-default"><i class="fa fa-download"></i> Download</a>
            {% endif %}
            <div class="btn-group">
                <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown"
                        aria-haspopup="true" aria-expanded="false">
                    <i class="fa fa-search"></i> Search <span class="caret"></span>
                </button>
                <ul class="dropdown-menu">
                    <li><a id="searchInternetArtist" href="#">Internet Artist</a></li>
                    <li><a id="searchInternetTitle" href="#">Internet Title</a></li>
                    <li><a id="searchInternetArtistAndTitle" href="#">Internet Artist and Title</a></li>
                </ul>
            </div>
        </div>
        {% if current_user.is_editor() %}
        <div class="btn-group">
            <a href="/release/edit/{{ release.roadieId }}"
               class="btn btn-warning"><i class="fa fa-edit"></i> Edit</a>
            <a id="findCoverArt" class="btn btn-warning"><i class="fa fa-picture-o"></i> Find Cover</a>
            {% if release.artist.isLocked == False %}
            <div class="btn-group">
                <button type="button" class="btn btn-danger dropdown-toggle" data-toggle="dropdown" aria-haspopup="true"
                        aria-expanded="false">
                    <i class="fa fa-trash-o"></i> Delete <span class="caret"></span>
                </button>
                <ul class="dropdown-menu">
                    <li><a id="deleteRelease" class="btn btn-danger"><i class="fa fa-trash-o"></i> Delete Release</a>
                    </li>
                    <li><a id="deleteReleaseAndTracks" class="btn btn-danger"><i class="fa fa-trash-o"></i> Delete
                        Release And Track Files</a></li>
                </ul>
            </div>
            <a id="scanRelease" class="btn btn-warning"><i class="fa fa-folder-open-o"></i> Re-Scan</a>
            {% endif %}
        </div>
        {% endif %}
        {% if release.artist.isLocked %}
        <span class="edit-locked label label-danger"><i class="fa fa-lock fa-2x" title="Artist Is Locked"></i></span>
        {% endif %}
    </div>
    <div class="row title bordered">
        <div class="col-md-12">
            <img id="release-thumbnail" class="release-thumb thumb pull-left" src="/images/release/thumbnail/{{ release.roadieId }}"
                 alt="{{ release.title }}"/>
            <div class="release-rating-container pull-left">
                <input type="hidden" class="rating" data-readonly value="{{ release.rating }}"/>
            </div>
            <div class="artist-info">
            </div>
            <h2 class="release-title-container">
                <span class="release-title label label-default">{{ release.title }}</span>
                {% if current_user.is_editor() %}
                <button id="setAlbumTitle" class="btn btn-warning btn-sm" title="Set Album Title"><i class="fa fa-edit"></i>
                </button>
                {% endif %}
            </h2>
            <div class="user-rating-container">
                <a href="#" class="dislike" title="Toggle Dislike Release"><i
                        class="fa {{ 'fa-thumbs-down' if userRelease.isDisliked else 'fa-thumbs-o-down'}}"></i></a>
                <span class="reset-rating fa fa-square" title="Remove Rating"></span>
                <input type="hidden" class="user-rating rating" value="{{ userRelease.rating }}"/>
                <a href="#" class="favorite" title="Toggle Favorite Release"><i
                        class="fa {{'fa-heart' if userRelease.isFavorite else 'fa-heart-o'}}"></i></a>
            </div>
        </div>
    </div>
    <div class="row bordered">
        <div class="col-md-6">
            <h4><span class="label label-primary">Profile</span></h4>
            <div>{{ release.profile|safe }}</div>
        </div>
        <div class="col-md-6">
            {% for image in release.images %}
            <div class="col-md-3 image-container">
                <a href="javascript:void(0);"
                   data-title="{{ image.caption }}"
                   data-url="/images/release/{{ image.roadieId }}/2048/2048"
                   target="_blank" class="thumbnail">
                    <img data-image-id="{{ image.roadieId }}" data-toggle="context"
                         data-target="#context-menu-{{ image.roadieId }}"
                         src="/images/release/{{ image.roadieId }}/512/512" alt="Image"/>
                </a>
            </div>
            <div id="context-menu-{{ image.roadieId }}" data-image-id="{{ image.roadieId }}" class="context-menu">
                <ul class="dropdown-menu" role="menu">
                    <li>
                        <a class="setReleaseImage" tabindex="-1"><i class="fa fa-file-image-o"></i> Set as Release Image</a>
                    </li>
                    <li>
                        <a class="deleteReleaseImage" tabindex="-1"><i class="fa fa-trash-o"></i> Delete Release Image</a>
                    </li>
                </ul>
            </div>
            {% endfor %}
        </div>
    </div>
    <div class="row details bordered">
        <div class="col-md-3">
            <div>
                <h4><span class="label label-primary">Release Date</span></h4>
                <span class="release-date label label-default">{{ release.releaseDate }}</span>
                {% if current_user.is_editor() %}
                <button id="setReleaseDate" class="btn btn-warning btn-sm" title="Set Release Date"><i
                        class="fa fa-edit"></i></button>
                {% endif %}
            </div>
        </div>
        <div class="col-md-3">
            <div>
                <h4><span class="label label-primary">Track Count</span></h4>
                <span id="releaseTrackCount" class="label label-default">{{ release.trackCount }}</span>
                <span title="Number of MP3 Files In Release Folder"
                      class="label {{ 'label-success' if numberOfMp3FilesInFolder == release.trackCount else 'label-warning' }}">{{ numberOfMp3FilesInFolder}}</span>
            </div>
            <div>
                <h4><span class="label label-primary">Media Count</span></h4>
                <span id="releaseMediaCount" class="label label-default">{{ release.mediaCount }}</span>
            </div>
        </div>
        <div class="col-md-3">
            <div>
                <h4><span class="label label-primary">Labels</span></h4>
                <ul>
                    {% for releaseLabel in release.releaseLabels %}
                    <li>
                        <span class="label label-default">{{ releaseLabel.label.name }}</span>
                        {% if releaseLabel.catalogNumber %}
                        <span class="label label-default">{{ releaseLabel.catalogNumber }}</span>
                        {% endif %}
                        {% if releaseLabel.beginDate %}
                        <span class="label label-default">{{ releaseLabel.beginDate }}</span>
                        {% endif %}
                        {% if releaseLabel.endDate %}
                        <span class="label label-default">{{ releaseLabel.endDate }}</span>
                        {% endif %}
                    </li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>
    {% if release.musicBrainzId or release.iTunesId or release.amgId or release.lastFMId or release.spotifyId %}
    <div class="row details bordered">
        {% if release.musicBrainzId %}
        <div class="col-md-2">
            <h4><span class="label label-primary">MusicBrainz Id</span></h4>
            <a href="https://musicbrainz.org/release/{{ release.musicBrainzId }}" target="_blank"><span
                    class="label label-default">{{ release.musicBrainzId }}</span></a>
        </div>
        {% endif %}
        {% if release.iTunesId %}
        <div class="col-md-2">
            <h4><span class="label label-primary">iTunes Id</span></h4>
            <a href="https://itunes.apple.com/us/album/{{ release.iTunesId }}" target="_blank"><span
                    class="label label-default">{{ release.iTunesId }}</span></a>
        </div>
        {% endif %}
        {% if release.amgId %}
        <div class="col-md-2">
            <h4><span class="label label-primary">All Music Guide Id</span></h4>
            <a href="https://itunes.apple.com/us/album/{{ release.amgId }}" target="_blank"><span
                    class="label label-default">{{ release.amgId }}</span></a>
        </div>
        {% endif %}
        {% if release.lastFMId %}
        <div class="col-md-2">
            <h4><span class="label label-primary">Last FM Id</span></h4>
            <a href="https://itunes.apple.com/us/album/{{ release.lastFMId }}" target="_blank"><span
                    class="label label-default">{{ release.lastFMId }}</span></a>
        </div>
        {% endif %}
        {% if release.spotifyId %}
        <div class="col-md-2">
            <h4><span class="label label-primary">Spotify Id</span></h4>
            <a href="https://play.spotify.com/album/{{ release.spotifyId }}" target="_blank"><span
                    class="label label-default">{{ release.spotifyId }}</span></a>
        </div>
        {% endif %}
    </div>
    {% endif %}
    <div class="row lists bordered">
        <div class="col-md-3">
            {% if collectionReleases %}
            <div>
                <h4><span class="label label-primary">Collections</span></h4>
                <ul class="no-list-style">
                    {% for collectionRelease in collectionReleases|sort(attribute='listNumber') %}
                    <li>
                        <a href="/collection/{{ collectionRelease.collectionReleases.roadieId }}">
                            <span class="label label-{{ 'success' if collectionRelease.listNumber == 1 else 'primary'}}">{{ '%03d' % collectionRelease.listNumber  }}</span>
                            <span data-toggle="tooltip" data-placement="top"
                                  title="{{ collectionRelease.collectionReleases.name }}"
                                  class="label label-default">{{ collectionRelease.collectionReleases.name }}</span>
                        </a>
                    </li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}
            {% if release.alternateNames %}
            <div class="">
                {% if release.alternateNames %}
                <h4><span class="label label-primary">Alternate Names</span></h4>
                <input type="text" class="form-control {{'tokenfield' if current_user.is_editor() else 'tokenfield-readonly' }}" id="alternateNamesTokenfield"
                       value="{{ release.alternateNames|sort|join('|') }}" />
                {% endif %}
            </div>
            {% endif %}
        </div>
        <div class="col-md-3">
            <div>
                {% if release.genres %}
                <h4><span class="label label-primary">Genres</span></h4>
                <input type="text" disabled class="form-control tokenfield-readonly" id="genreTokenfield"
                       value="{{ release.genres|sort(attribute='name')|join(',', attribute='name') }}"/>
                {% endif %}
            </div>
        </div>
        {% if release.tags %}
        <div class="col-md-3">
            <h4><span class="label label-primary">Tags</span></h4>
            <input type="text" disabled class="form-control tokenfield-readonly" id="tagTokenfield"
                   value="{{ release.tags|sort|join(',') }}"/>
        </div>
        {% endif %}
        <div class="col-md-3">
            <div>
                {% if current_user.has_role("Admin") %}
                <h4><span class="label label-primary">Library Folders</span></h4>
                <ul class="folders">
                    {% for group in release|group_release_tracks_filepaths %}
                    <li>
                        <span class="length label label-info">{{ group }}</span>
                    </li>
                    {% endfor %}
                </ul>
                {% endif %}
            </div>
            {% if release.urls %}
            <div>
                <h4><span class="label label-primary">Urls</span></h4>
                <ul>
                    {% for url in release.urls %}
                    <li>
                        <a href="{{ url }}" target="_blank"
                           data-toggle="tooltip" data-placement="top"
                           title="{{url }}">
                            <span class="label label-default">{{ url }}</span>
                        </a>
                    </li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}
        </div>
    </div>
    <div class="row tracks bordered">
        {% for media in release.media|sort(attribute='releaseMediaNumber') %}
        <div class="release-media-container" data-releasemedianumber="{{ media.releaseMediaNumber }}" data-releasemediatrackcount="{{ media.trackCount }}">
            <h5 class="release-cd"><span class="label label-success">CD {{ media.releaseMediaNumber }}</span></h5>
            {% if media.releaseSubTitle %}
            <h5 class="release-media-subtitle pull-right"><span class="label label-success">CD {{ media.releaseSubTitle }}</span>
            </h5>
            {% endif %}
            {% for track in media.tracks|sort(attribute='trackNumber') %}
            <div class="row track {{ '' if track.fileName else 'missing' }}" data-track-id="{{ track.roadieId }}">
                <div class="col-xs-1 col-sm-1 col-md-1 col-lg-1">
                    <span class="trackNumber label label-primary">{{ '%02d' % track.trackNumber }}</span>
                </div>
                <div class="col-xs-2 col-sm-6 col-md-6 col-lg-7">
                    <span data-toggle="tooltip" data-placement="top" title="{{ track.title }}"
                          class="title label label-default">{{ track.title }}</span>
                    {% if track.partTitles|count > 0 %}
                    <ul class="part-titles">
                        {% for parttitle in track.partTitles %}
                        <li><span class="label label-default part-title">{{ parttitle }}</span></li>
                        {% endfor %}
                    </ul>
                    {% endif %}
                    {% if track.artist and track.artist.id != release.artist.id %}
                    <a href="/artist/{{ track.artist.roadieId }}">
                        <img class="label-thumb thumb track-artist" src="/images/artist/thumbnail/{{ track.artist.roadieId }}"
                             alt="{{ track.artist.name }}"/>
                        <span data-toggle="tooltip" data-placement="top" title="{{ track.artist.name }}"
                              class="track-artist-name label label-default">{{ track.artist.name }}</span>
                    </a>
                    {% endif %}
                </div>
                <div class="col-xs-1 col-sm-1 col-md-1 col-lg-1">
                    <div class="dropdown">
                        <button type="button" class="btn btn-default btn-xs dropdown-toggle" data-toggle="dropdown"
                                aria-haspopup="true" aria-expanded="false">
                            <i class="fa fa-bars"></i> <span class="caret"></span>
                        </button>
                        <ul class="dropdown-menu">
                            <li><a href="#" class="play-track btn btn-default"><i class="fa fa-play"></i> Play</a></li>
                            <li><a href="#" class="que-track btn btn-default"><i class="fa fa-plus"></i> Que</a></li>
                            {% if current_user.is_editor() %}
                            <li><a href="#" class="edit-track btn btn-warning"><i class="fa fa-edit"></i> Edit</a></li>
                            <li class="dropdown-submenu">
                                <a tabindex="-1" href="#" class="btn btn-warning"><i class="fa fa-trash-o"></i>
                                    Delete</a>
                                <ul class="dropdown-menu">
                                    <li><a href="#" data-toggle="tooltip" data-placement="left" title="Delete the Track"
                                           class="delete-track btn btn-warning"><i class="fa fa-trash-o"></i> Delete
                                        Track</a></li>
                                    <li><a href="#" data-toggle="tooltip" data-placement="left"
                                           title="Delete the Track, and delete the File"
                                           class="delete-track-and-file btn btn-warning"><i class="fa fa-trash-o"></i>
                                        Delete</a></li>
                                </ul>
                            </li>
                            {% endif %}
                        </ul>
                    </div>
                </div>
                <div class="col-xs-8 col-sm-4 col-md-4 col-lg-3">
                    <span data-track-duration="{{ track.duration }}"
                          class="duration label label-info">{{ track.duration|format_tracktime() }}</span>
                            <span class="user-rating-container">
                                <span class="reset-rating fa fa-square" title="Remove Rating"></span>
                                <input type="hidden" class="track-rating user-rating rating"
                                       value="{{ track.userRatings|get_user_track_rating(user=g.user) }}"/>
                            </span>
                </div>
            </div>
            {% endfor %}
        </div>
        {% endfor %}
    </div>
    <div class="row lists bordered danger insane-messages" style="display:none;">
        <dl></dl>
    </div>
    <div class="meta pull-right">
        <p><span class="label label-info">Last Modified: {{ (release.lastUpdated or release.createdDate)|format_datetime_for_user(user=g.user) }}</span></p>
    </div>
</div>
{% endblock %}
{% block script_content %}
<script type="text/javascript">
    var artistId = '{{ release.artist.roadieId }}';
    var releaseId = '{{ release.roadieId }}';
    var selectedCoverUrl = null;
    var numberOfMp3FilesInFolder = {{ numberOfMp3FilesInFolder}};

    var showInsaneMessage = function(message) {
        $("div.insane-messages dl:first").append("<dd class='label label-danger'>" + message + "</dd>").parent().show();
    };

    var doTrackDelete = function(trackId, flag) {
        $.ajax({
            type: 'POST',
            url: '/releasetrack/delete/' + releaseId + "/" + trackId + "/" + flag,
            contentType: "application/javascript",
            success: function(data) {
                if(data.message == "OK") {
                    location.reload();
                }
            },
            error:function(jq, st, error){
                roadieLibrary.showErrorMessage(error);
            }
        });
    };

    var doReleaseSanityChecks = function() {
        var $c = $("div.release-counts-container");
        var $qe = $(".tracks .insane-quick-edit");
        $c.find(".track-count-indicator").remove();
        if(isReleaseSane()) {
            $c.append("<span class='track-count-indicator track-count-valid label label-success' title='Release Seems Sane!'><i class='fa fa-check-square-o fa-2x'></i></span>");
            $qe.hide();
        } else {
            $c.append("<span class='track-count-indicator track-count-valid label label-danger' title='Release Has Issues'><i class='fa fa-square-o fa-2x'></i></span>");
            $qe.fadeIn();
        }
    };

    var isReleaseSane = function() {
        var r1 = doTrackCountsMatch();
        var r2 = areNoTracksOfZeroLength();
        var r3 = doReleaseMediaCountsMatch();
        var r4 = areTracksNumberedSequentially();
        var r5 = isReleaseMarkedComplete();
        return  r1 && r2 && r3 && r4 && r5;
    };

    var isReleaseMarkedComplete = function() {
        var isComplete =  $(".release-detail-container").hasClass("librarystatus_complete");
        if(!isComplete) {
            showInsaneMessage("Release Is Marked Incomplete!");
        }
        return isComplete;
    };

    var areNoTracksOfZeroLength = function() {
        var result = true;
        $.each($("div.tracks span.length"), function(i,d) {
            var $t = $(d);
            trackLength = parseInt($t.data("track-length"));
            if(trackLength < 1) {
                result = false;
                showInsaneMessage("Track [" + $t.data("track-id") + "] Has Invalid Track Length");
                return false;
            }
        });
        return result;
    };

    var doTrackCountsMatch = function() {
        var releaseTrackCount = parseInt($("#releaseTrackCount").text());
        var foundTracks = parseInt($("span.track-count").data("track-count"));
        var sane = releaseTrackCount === foundTracks && numberOfMp3FilesInFolder === foundTracks;
        if (!sane) {
            $("#releaseTrackCount").removeClass("label-default").addClass("label-danger");
            showInsaneMessage("Release Track Count [" + releaseTrackCount + "], Does Not Match Found Tracks [" + foundTracks + "]");
        }
        return sane
    };

    var doReleaseMediaCountsMatch = function() {
        var mediaCount = parseInt($(".media-count").data("media-count"));
        var foundMedia = parseInt($("#releaseMediaCount").text());
        var sane = mediaCount === foundMedia;
        if (!sane) {
            $("#releaseDiscCount").removeClass("label-default").addClass("label-danger");
            showInsaneMessage("Release Media Counts Insane, discCount [" + mediaCount + "], foundMedia [" + foundMedia + "]");
        }
        return sane;
    };

    var areTracksNumberedSequentially = function() {
        var sane = true;
        var firstTrackOnDisc = null;
        var discCount = parseInt($(".media-count").data("media-count"));
        var foundMediaCount = parseInt($(".release-media-container[data-releasemedianumber]").length);
        if (discCount !== foundMediaCount) {
            showInsaneMessage("Found Media Count [" + foundMediaCount + "] Does Not Match Release Media Count [" + discCount + "]");
            sane = false;
        }
        for(var disc = 1; disc <= discCount; disc++) {
            var trackLooper = 1;
            $.each($(".release-media-container[data-releasemedianumber='" + disc + "'] .track span.trackNumber "), function(i,d) {
                var $this = $(this);
                var isTrackNumberRight = trackLooper === parseInt($this.text());
                if (!isTrackNumberRight) {
                    $this.removeClass("label-primary").addClass("label-danger").attr("title", "Track Number Sequence is Invalid");
                    showInsaneMessage("Track Number Sequence is Insane, Expected [" + trackLooper + "], Found [" + parseInt($this.text()) + "]");
                }
                sane = sane && isTrackNumberRight;
                trackLooper++;
            });
            trackLooper--;
            var mediaTrackCount = parseInt($(".release-media-container[data-releasemedianumber='" + disc + "']").data("releasemediatrackcount"));
            if(trackLooper !== mediaTrackCount) {
                showInsaneMessage("Media Number [" + disc + "] Track Count [" + mediaTrackCount + "] Does Not Match Found Tracks For Media [" + trackLooper + "]");
                sane = false;
            }
        }
        return sane;
    };

    var buildHtmlForImageSearch = function(data) {
        var html = '<div class="image-search-results">';
        html += '<div class="image-search-query form-group"><input class="form-control" onKeyDown="doImageSearch(event)" id="query" type="text" value="' + decodeURIComponent(data.query) + '" /></div>';
        $.each(data.data, function(i,d) {
            html += '<div class="image-search-result pull-left"><a href="#">';
            html += '<img src="' + d.url + '" />';
            html += '<div><span class="label label-default">' + d.width + 'x' + d.height + '</span></div></div>';
        });
        html += '</div>';
        html += '<script>$(".image-search-results").on("click", ".image-search-result a", function(e) { var $t = $(this); selectedCoverUrl = $t.find("img").attr("src"); $(".image-search-result").removeClass("selected"); $t.closest("div").addClass("selected"); });<\/script>';
        return html;
    };

    var doImageSearch = function(e) {
        if(e.keyCode == 13){
			e.preventDefault();
			e.stopPropagation();
            var query = $(e.target).val();
            $.ajax({
                type: 'POST',
                url: '/images/find/r/' + releaseId,
                data: { "query": encodeURIComponent(query) },
                success: function(data) {
                    if(data.message == "OK") {
                        $(".image-search-results").html(buildHtmlForImageSearch(data));
                    }
                },
                error:function(jq, st, error){
                    roadieLibrary.showErrorMessage(error);
                }
            });
        }
    };

    var doDelete = function(deleteFiles) {
        $(".loader").fadeIn("slow", function() {
            $.ajax({
                type: 'POST',
                url: '/release/delete/' + releaseId + '/' + deleteFiles,
                contentType: "application/javascript",
                success: function(data) {
                    if(data.message == "OK") {
                        window.location.href = '/artist/' + artistId;
                    }
                },
                error:function(jq, st, error){
                    roadieLibrary.showErrorMessage(error);
                }
            });
        });
    };

    $(function() {

        $(".tokenfield-readonly").tokenfield();

        $("#labelPicker").on("change", function(i,d){
            window.location = '/label/' + $(this).find("option:selected").val();
        });

        roadieLibrary.setFavIcon("release-thumbnail");

        $("#alternateNamesTokenfield").tokenfield({
            delimiter: '|',
            delay: 100,
            beautify: false,
        }).on('tokenfield:createtoken', function(event) {
            var existingTokens = $(this).tokenfield('getTokens');
            $.each(existingTokens, function(index, token) {
                if (token.value === event.attrs.value)
                    event.preventDefault();
            });
        }).on('tokenfield:removedtoken tokenfield:createdtoken tokenfield:editedtoken', function(event) {
            $.ajax({
                type: 'POST',
                url: '/release/setalternatenames/' + releaseId,
                data: { "alternatenames": JSON.stringify($(this).tokenfield('getTokens')) },
                success: function(data) {
                    if(data.message != "OK") {
                        roadieLibrary.showErrorMessage("Error Saving Alternate Names");
                    }
                },
                error:function(jq, st, error){
                    roadieLibrary.showErrorMessage(error);
                }
            });
        });

        doReleaseSanityChecks();

            $(".release-detail-container .title .user-rating-container a.dislike").on("click", function(e) {
                var $i =  $(this).find("i:first");
                var toggle = !$i.hasClass("fa-thumbs-down");
                $.ajax({
                    type: 'POST',
                    url: '/user/release/toggledislike/' + releaseId + '/' + toggle,
                    contentType: "application/javascript",
                    success: function(data) {
                        if(data.message == "OK") {
                            roadieLibrary.showSuccessMessage("Successfully Toggled Dislike");
                            if(toggle) {
                                $i.removeClass("fa-thumbs-o-down").addClass("fa-thumbs-down");
                                $(".user-rating-container input.rating").rating('rate',0);
                                $(".rating-container input.rating").rating('rate', data.average);
                            } else {
                                $i.removeClass("fa-thumbs-down").addClass("fa-thumbs-o-down");
                            }
                        }
                    },
                    error:function(jq, st, error){
                        roadieLibrary.showErrorMessage(error);
                    }
                });
            });
            $(".release-detail-container .title .user-rating-container a.favorite").on("click", function(e) {
                var $i =  $(this).find("i:first");
                var toggle = !$i.hasClass("fa-heart");
                $.ajax({
                    type: 'POST',
                    url: '/user/release/togglefavorite/' + releaseId + '/' + toggle,
                    contentType: "application/javascript",
                    success: function(data) {
                        if(data.message == "OK") {
                            roadieLibrary.showSuccessMessage("Successfully Toggled Favorite");
                            if(toggle) {
                                $i.removeClass("fa-heart-o").addClass("fa-heart");
                            } else {
                                $i.removeClass("fa-heart").addClass("fa-heart-o");
                            }
                        }
                    },
                    error:function(jq, st, error){
                        roadieLibrary.showErrorMessage(error);
                    }
                });
            });
            $(".title .user-rating-container input.user-rating").on("change", function(e) {
                $.ajax({
                    type: 'POST',
                    url: '/user/release/setrating/' + releaseId + '/' + $(this).rating('rate'),
                    contentType: "application/javascript",
                    success: function(data) {
                        if(data.message == "OK") {
                            $(".release-rating-container input.rating").rating('rate', data.average);
                            roadieLibrary.showSuccessMessage("Successfully Set Rating");
                        }
                    },
                    error:function(jq, st, error){
                        roadieLibrary.showErrorMessage(error);
                    }
                });
            });

        $(".title .user-rating-container span.reset-rating").on("click", function(e) {
            var $r = $(this).siblings("input.user-rating");
            $.ajax({
                type: 'POST',
                url: '/user/release/setrating/' + releaseId + '/0',
                contentType: "application/javascript",
                success: function(data) {
                    if(data.message == "OK") {
                        $r.rating('rate', 0);
                         $(".release-rating-container input.rating").rating('rate', data.average);
                        roadieLibrary.showSuccessMessage("Successfully Removed Rating");
                    }
                },
                error:function(jq, st, error){
                    roadieLibrary.showErrorMessage(error);
                }
            });
        });

        $(".release-detail-container .tracks input.track-rating").on("change", function(e) {
            $.ajax({
                type: 'POST',
                url: '/user/track/setrating/' + $(this).closest("div.track").data("track-id") + '/' + $(this).rating('rate'),
                contentType: "application/javascript",
                success: function(data) {
                    if(data.message == "OK") {
                        roadieLibrary.showSuccessMessage("Successfully Set Rating");
                    }
                },
                error:function(jq, st, error){
                    roadieLibrary.showErrorMessage(error);
                }
            });
        });

        $(".release-detail-container .tracks span.reset-rating").on("click", function(e) {
            var $r = $(this).siblings("input.track-rating");
            $.ajax({
                type: 'POST',
                url: '/user/track/setrating/' + $(this).closest("div.track").data("track-id") + '/0',
                contentType: "application/javascript",
                success: function(data) {
                    if(data.message == "OK") {
                        $r.rating('rate', 0);
                        roadieLibrary.showSuccessMessage("Successfully Removed Rating");
                    }
                },
                error:function(jq, st, error){
                    roadieLibrary.showErrorMessage(error);
                }
            });
        });

        $(".release-detail-container a.thumbnail").on("click", function(e) {
            e.preventDefault();
            var $t = $(this);
            bootbox.dialog({
                title: $t.data("title"),
                size: 'large',
                message: '<img src="' + $t.data("url") + '" style="max-width: 100%;" />'
            });
        });
        $("#playAll").on("click", function(e) {
           roadieLibrary.playLoader("/release/play/" + releaseId);
        });
        $("#downloadRelease").on("click", function(e) {
            roadieLibrary.downloadRelease("/release/download/" + releaseId);
        });
        $("div.tracks a.que-track").on("click", function(e) {
            var trackid = $(this).closest("div.row").data("track-id");
            queManager.addToQue("track", releaseId, trackid);
        });
        $("div.tracks a.play-track").on("click", function(e) {
            var trackid = $(this).closest("div.row").data("track-id");
            roadieLibrary.playLoader("/track/play/" + releaseId + "/" + trackid);
        });
        $("div.tracks a.edit-track").on("click", function(e) {
            var trackid = $(this).closest("div.row").data("track-id");
            window.location.href = "/track/edit/" + trackid + "/" + releaseId;
        });
        $("div.tracks a.deleteRelease-track").on("click", function(e) {
            var trackid = $(this).closest("div.row").data("track-id");
            bootbox.confirm("Continue To Delete Release Track?", function(result) {
                if(result) {
                    doTrackDelete(trackid, 'rt');
                }
            })
        });
        $("div.tracks a.delete-track").on("click", function(e) {
            var trackid = $(this).closest("div.row").data("track-id");
            bootbox.confirm("Continue To Delete Release Track and Track?", function(result) {
                if(result) {
                    doTrackDelete(trackid, 't');
                }
            })
        });
        $("div.tracks a.delete-track-and-file").on("click", function(e) {
            var trackid = $(this).closest("div.row").data("track-id");
            bootbox.confirm("Continue To Delete Release Track, Track and File?", function(result) {
                if(result) {
                    doTrackDelete(trackid, 'f');
                }
            })
        });
        $("#deleteRelease").on("click", function(e) {
            bootbox.confirm("Continue To Delete Release?", function(result) {
                if(result) {
                    doDelete(false);
                }
            });
        });
        $("#deleteReleaseAndTracks").on("click", function(e) {
            bootbox.confirm("Continue To Delete Release and Delete Files?", function(result) {
                if(result) {
                    doDelete(true);
                }
            });
        });

        $("a.setReleaseImage").on("click", function(e) {
            var $t = $(this);
            var imageId = $t.parents(".context-menu").data("image-id");
            $.ajax({
                type: 'POST',
                url: '/release/setimage/' + releaseId + '/' + imageId,
                contentType: "application/javascript",
                success: function(data) {
                    $("#release-thumbnail").attr("src", "/images/release/thumbnail/" + releaseId + "?" + new Date().getTime());
                    roadieLibrary.setFavIcon("release-thumbnail");
                },
                error:function(jq, st, error){
                    roadieLibrary.showErrorMessage(error);
                }
            });
        });

        $("a.deleteReleaseImage").on("click", function(e) {
            var $t = $(this);
            bootbox.confirm("Continue To Delete Release Image?", function(result) {
                if(result) {
                    var imageId = $t.parents(".context-menu").data("image-id");
                    $.ajax({
                        type: 'POST',
                        url: '/release/deleteimage/' + releaseId + '/' + imageId,
                        contentType: "application/javascript",
                        success: function(data) {
                            $("img[data-image-id='" + imageId + "']").closest("div.image-container").remove();
                        },
                        error:function(jq, st, error){
                            roadieLibrary.showErrorMessage(error);
                        }
                    });
                }
            });
        });


        $("#scanRelease").on("click", function(e) {
            bootbox.confirm("Continue To Re-Scan Release Folder(s)?", function(result) {
                if(result) {
                    $(".loader").fadeIn("slow", function() {
                        $.ajax({
                            type: 'POST',
                            url: '/release/rescan/' + releaseId,
                            contentType: "application/javascript",
                            success: function(data) {
                                if(data.message == "OK") {
                                    location.reload(true);
                                }
                            },
                            error:function(jq, st, error){
                                roadieLibrary.showErrorMessage(error);
                            }
                        });
                    });
                }
            });
        });

        $("#findCoverArt").on("click", function(e) {
            if($(this).hasClass("clicked")) {
                return false;
            }
            var $that = $(this);
            $that.addClass("clicked");
            $.ajax({
                type: 'POST',
                url: '/images/find/r/' + releaseId,
                contentType: "application/javascript",
                success: function(data) {
                    if(data.message == "OK") {
                        bootbox.dialog({
                            buttons: {
                                cancel: {
                                    label: "Cancel",
                                    className: "btn-default",
                                    callback: function() {
                                        $that.removeClass("clicked");
                                    }
                                },
                                save: {
                                    label: "Save",
                                    className: "btn-success",
                                    callback: function() {
                                        if(selectedCoverUrl) {
                                            $.ajax({
                                                type: 'POST',
                                                url: '/release/setCoverViaUrl/' + releaseId,
                                                data: { "url": encodeURIComponent(selectedCoverUrl) },
                                                success: function(data) {
                                                    if(data.message == "OK") {
                                                        $("#release-thumbnail").attr("src", "/images/release/thumbnail/" + releaseId + "?" + new Date().getTime());
                                                        roadieLibrary.setFavIcon("release-thumbnail");
                                                    }
                                                    $that.removeClass("clicked");
                                                },
                                                error:function(jq, st, error){
                                                    roadieLibrary.showErrorMessage(error);
                                                }
                                            });
                                        }
                                    }
                                }
                            },
                            title: "Image Search Results",
                            message: buildHtmlForImageSearch(data)
                        });
                    }
                },
                error:function(jq, st, error){
                    roadieLibrary.showErrorMessage(error);
                }
            });
        });

        $("input.track-select").on("change", function(e) {
            var checkedCount = $("input.track-select:checked").length;
            if (checkedCount) {
                $("#withSelected").removeClass("disabled");
            } else {
                $("#withSelected").addClass("disabled");
            }
        });


        $("#searchInternetArtist").on("click", function() {
            roadieLibrary.doInternetSearch($("span.release-artist-name").text() + " Band");
        });

        $("#searchInternetTitle").on("click", function() {
            roadieLibrary.doInternetSearch($("span.release-title").text() + " Album");
        });

        $("#searchInternetArtistAndTitle").on("click", function() {
            roadieLibrary.doInternetSearch($("span.release-artist-name").text() + " " + $("span.release-title").text());
        });

        $("#setReleaseDate").on("click", function(e) {
            var currentDate = $("span.release-date").text();
            bootbox.dialog({
                title: "Set Release Date",
                message: '<div class="row">  ' +
                    '<div class="col-md-12"> ' +
                    '<form class="form-horizontal"> ' +
                    '<div class="form-group"> ' +
                    '<label class="col-md-5 control-label" for="date">Date</label> ' +
                    '<div class="col-md-7"> ' +
                    '<input id="newDate" name="newDate" type="text" placeholder="Release Date" class="form-control input-md" value="' + currentDate + '" /> ' +
                    '</div></div> ' +
                    '<div class="form-group"><label class="col-md-5 control-label" for="set_tracks_year">Set Track(s) Year?</label> ' +
                    '<div class="col-md-7 checkbox"><label><input type="checkbox" name="set_tracks_year" id="set_tracks_year" value="True" checked="checked">Yes</label>' +
                    '</div></div>' +
                    '</div>' +
                    '</form> </div></div>',
                buttons: {
                    cancel: {
                        label: "Cancel",
                        className: "btn-default"
                    },
                    success: {
                        label: "Save",
                        className: "btn-success",
                        callback: function () {
                            var newReleaeDate = $('#newDate').val();
                            var doSetTracksYear = $("input[name='set_tracks_year']:checked").val();
                            if (typeof doSetTracksYear === "undefined") {
                                doSetTracksYear = false;
                            } else {
                                doSetTracksYear = true;
                            }
                            $(".loader").fadeIn("slow", function() {
                                $.ajax({
                                    type: 'POST',
                                    url: '/release/setReleaseDate/' + releaseId + '/' + encodeURIComponent(newReleaeDate) + '/' + doSetTracksYear,
                                    success: function(data) {
                                        if(data.message == "OK") {
                                            location.reload(true);
                                        }
                                    },
                                    error:function(jq, st, error){
                                        roadieLibrary.showErrorMessage(error);
                                    }
                                });
                            });
                        }
                    }
                }
            });
        });

        $("#setAlbumTitle").on("click", function(e) {
            var currentTitle = $("span.release-title").text();
            bootbox.dialog({
                title: "Set Release Title",
                message: '<div class="row">  ' +
                    '<div class="col-md-12"> ' +
                    '<form class="form-horizontal"> ' +
                    '<div class="form-group"> ' +
                    '<label class="col-md-5 control-label" for="name">Name</label> ' +
                    '<div class="col-md-7"> ' +
                    '<input id="newTitle" name="newTitle" type="text" placeholder="Title" class="form-control input-md" value="' + currentTitle + '" /> ' +
                    '</div></div> ' +
                    '<div class="form-group"><label class="col-md-5 control-label" for="setTracksTitle">Set Track(s) Title?</label> ' +
                    '<div class="col-md-7 checkbox"><label><input type="checkbox" name="setTracksTitle" id="setTracksTitle" value="True" checked="checked">Yes</label>' +
                    '</div></div>' +
                    '<div class="form-group"><label class="col-md-5 control-label" for="createAlternateName">Create Release Alternate?</label> ' +
                    '<div class="col-md-7 checkbox"><label><input type="checkbox" name="createAlternateName" id="createAlternateName" value="True" checked="checked">Yes</label>' +
                    '</div></div>' +
                    '</div>' +
                    '</form> </div></div>',
                buttons: {
                    cancel: {
                        label: "Cancel",
                        className: "btn-default"
                    },
                    success: {
                        label: "Save",
                        className: "btn-success",
                        callback: function () {
                            var newTitle = $('#newTitle').val();
                            var doSetTracksTitle = $("input[name='setTracksTitle']:checked").val();
                            if (typeof doSetTracksTitle === "undefined") {
                                doSetTracksTitle = false;
                            } else {
                                doSetTracksTitle = true;
                            }
                            var doCreateAlternateName = $("input[name='createAlternateName']:checked").val();
                            if (typeof doCreateAlternateName === "undefined") {
                                doCreateAlternateName = false;
                            } else {
                                doCreateAlternateName = true;
                            }
                            $(".loader").fadeIn("slow", function() {
                                $.ajax({
                                    type: 'POST',
                                    url: '/release/setTitle/' + releaseId,
                                    data: { "tracksToMove": encodeURIComponent(newTitle),
                                            "doSetTracksTitle": doSetTracksTitle,
                                            "doCreateAlternateName": doCreateAlternateName },
                                    success: function(data) {
                                        if(data.message == "OK") {
                                            location.reload(true);
                                        }
                                    },
                                    error:function(jq, st, error){
                                        roadieLibrary.showErrorMessage(error);
                                    }
                                });
                            });
                        }
                    }
                }
            })
        });

    });

</script>
{% endblock %}
